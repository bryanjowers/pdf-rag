<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Viewer - PDF-RAG Pipeline</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        /* Custom scrollbar for file list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden" x-data="qaViewer()" x-init="loadFiles()">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">QA Viewer</h1>
                <p class="text-sm text-gray-600 mt-1">PDF-RAG Pipeline Quality Assurance</p>
            </div>

            <!-- Stats Summary -->
            <div class="flex gap-6 text-sm" x-show="files.length > 0">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" x-text="stats.success"></div>
                    <div class="text-gray-600">Success</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600" x-text="stats.pending"></div>
                    <div class="text-gray-600">Pending</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" x-text="stats.quarantined"></div>
                    <div class="text-gray-600">Errors</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex h-[calc(100vh-88px)]">

        <!-- Left Sidebar - File List -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col">

            <!-- Search and Filters -->
            <div class="p-4 border-b border-gray-200 space-y-3">
                <!-- Search -->
                <input
                    type="text"
                    x-model="searchQuery"
                    @input="filterFiles()"
                    placeholder="Search files..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />

                <!-- Status Filter -->
                <select
                    x-model="statusFilter"
                    @change="filterFiles()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="all">All Files</option>
                    <option value="success">Success Only</option>
                    <option value="quarantined">Quarantined Only</option>
                    <option value="pending">Pending Only</option>
                </select>

                <!-- Sort By -->
                <select
                    x-model="sortBy"
                    @change="filterFiles()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="name">Sort by Name</option>
                    <option value="pages">Sort by Pages</option>
                    <option value="duration">Sort by Duration</option>
                    <option value="tokens">Sort by Tokens</option>
                </select>
            </div>

            <!-- File List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <template x-if="loading">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-gray-500">Loading files...</div>
                    </div>
                </template>

                <template x-if="!loading && filteredFiles.length === 0">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-gray-500 text-center px-4">
                            <p class="font-medium">No files found</p>
                            <p class="text-sm mt-1">Try adjusting your filters</p>
                        </div>
                    </div>
                </template>

                <div class="divide-y divide-gray-200">
                    <template x-for="file in filteredFiles" :key="file.file_name">
                        <button
                            @click="selectFile(file)"
                            :class="{
                                'bg-blue-50 border-l-4 border-l-blue-500': selectedFile && selectedFile.file_name === file.file_name,
                                'hover:bg-gray-50': !selectedFile || selectedFile.file_name !== file.file_name
                            }"
                            class="w-full text-left px-4 py-3 transition-colors"
                        >
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 truncate" x-text="file.file_name"></div>
                                    <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                        <span x-show="file.page_count" x-text="file.page_count + ' pages'"></span>
                                        <span x-show="file.estimated_tokens" x-text="file.estimated_tokens + ' tokens'"></span>
                                    </div>
                                </div>
                                <div>
                                    <span
                                        x-show="file.status === 'success'"
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                                    >
                                        ✓
                                    </span>
                                    <span
                                        x-show="file.status === 'quarantined'"
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800"
                                    >
                                        ✗
                                    </span>
                                    <span
                                        x-show="!file.status || file.status === 'pending'"
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800"
                                    >
                                        ⏳
                                    </span>
                                </div>
                            </div>
                        </button>
                    </template>
                </div>
            </div>
        </aside>

        <!-- Center Panel - PDF Viewer -->
        <div class="flex-1 bg-gray-100 flex flex-col">
            <div class="bg-white border-b border-gray-200 px-4 py-2">
                <h2 class="text-sm font-semibold text-gray-700">Original PDF</h2>
            </div>
            <div class="flex-1 overflow-hidden">
                <template x-if="!selectedFile">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-gray-400 text-center">
                            <svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="font-medium">Select a file to view</p>
                        </div>
                    </div>
                </template>

                <template x-if="selectedFile">
                    <iframe
                        :src="'/pdf/' + selectedFile.file_name"
                        class="w-full h-full border-0"
                        @error="handlePdfError()"
                    ></iframe>
                </template>
            </div>
        </div>

        <!-- Right Panel - Markdown Viewer -->
        <div class="flex-1 bg-white flex flex-col border-l border-gray-200">
            <div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
                <h2 class="text-sm font-semibold text-gray-700">Extracted Markdown</h2>
                <button
                    x-show="selectedFile"
                    @click="showMetadata = !showMetadata"
                    class="text-xs text-blue-600 hover:text-blue-800"
                >
                    <span x-text="showMetadata ? 'Hide Metadata' : 'Show Metadata'"></span>
                </button>
            </div>

            <!-- Metadata Card (Collapsible) -->
            <div x-show="selectedFile && showMetadata" x-collapse class="border-b border-gray-200 bg-gray-50 p-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Status:</span>
                        <span class="ml-2 font-medium" :class="{
                            'text-green-600': selectedFile && selectedFile.status === 'success',
                            'text-red-600': selectedFile && selectedFile.status === 'quarantined',
                            'text-yellow-600': selectedFile && (!selectedFile.status || selectedFile.status === 'pending')
                        }" x-text="selectedFile ? (selectedFile.status || 'pending') : ''"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Processor:</span>
                        <span class="ml-2 font-medium text-gray-900" x-text="selectedFile ? selectedFile.processor : ''"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Pages:</span>
                        <span class="ml-2 font-medium text-gray-900" x-text="selectedFile ? (selectedFile.page_count || 'N/A') : ''"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Chunks:</span>
                        <span class="ml-2 font-medium text-gray-900" x-text="selectedFile ? selectedFile.chunks_created : ''"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Duration:</span>
                        <span class="ml-2 font-medium text-gray-900" x-text="selectedFile ? formatDuration(selectedFile.processing_duration_ms) : ''"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Tokens:</span>
                        <span class="ml-2 font-medium text-gray-900" x-text="selectedFile ? selectedFile.estimated_tokens : ''"></span>
                    </div>
                    <div class="col-span-2" x-show="selectedFile && selectedFile.error">
                        <span class="text-gray-600">Error:</span>
                        <div class="mt-1 p-2 bg-red-50 border border-red-200 rounded text-red-700 text-xs" x-text="selectedFile ? selectedFile.error : ''"></div>
                    </div>
                    <div class="col-span-2" x-show="selectedFile && selectedFile.warnings">
                        <span class="text-gray-600">Warnings:</span>
                        <div class="mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-700 text-xs" x-text="selectedFile ? selectedFile.warnings : ''"></div>
                    </div>
                </div>
            </div>

            <!-- Markdown Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <template x-if="!selectedFile">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-gray-400 text-center">
                            <svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="font-medium">Select a file to view</p>
                        </div>
                    </div>
                </template>

                <template x-if="selectedFile">
                    <iframe
                        :src="'/md/' + selectedFile.file_name"
                        class="w-full h-full border-0"
                        @error="handleMarkdownError()"
                    ></iframe>
                </template>
            </div>
        </div>
    </div>

    <script>
        function qaViewer() {
            return {
                // State
                files: [],
                filteredFiles: [],
                selectedFile: null,
                searchQuery: '',
                statusFilter: 'all',
                sortBy: 'name',
                loading: true,
                showMetadata: false,

                // Computed stats
                get stats() {
                    return {
                        success: this.files.filter(f => f.status === 'success').length,
                        quarantined: this.files.filter(f => f.status === 'quarantined').length,
                        pending: this.files.filter(f => !f.status || f.status === 'pending').length
                    };
                },

                // Load files from API
                async loadFiles() {
                    try {
                        const response = await fetch('/api/files');
                        const data = await response.json();

                        if (data.error) {
                            console.error('Error loading files:', data.error);
                            alert('Failed to load files: ' + data.error);
                            return;
                        }

                        this.files = data.files;
                        this.filterFiles();
                        this.loading = false;

                        console.log(`Loaded ${this.files.length} files`);
                    } catch (error) {
                        console.error('Error loading files:', error);
                        alert('Failed to load files. Check console for details.');
                        this.loading = false;
                    }
                },

                // Filter and sort files
                filterFiles() {
                    let filtered = [...this.files];

                    // Apply search filter
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(f =>
                            f.file_name.toLowerCase().includes(query)
                        );
                    }

                    // Apply status filter
                    if (this.statusFilter !== 'all') {
                        filtered = filtered.filter(f => {
                            if (this.statusFilter === 'pending') {
                                return !f.status || f.status === 'pending';
                            }
                            return f.status === this.statusFilter;
                        });
                    }

                    // Apply sort
                    filtered.sort((a, b) => {
                        switch (this.sortBy) {
                            case 'name':
                                return a.file_name.localeCompare(b.file_name);
                            case 'pages':
                                return (b.page_count || 0) - (a.page_count || 0);
                            case 'duration':
                                return (b.processing_duration_ms || 0) - (a.processing_duration_ms || 0);
                            case 'tokens':
                                return (b.estimated_tokens || 0) - (a.estimated_tokens || 0);
                            default:
                                return 0;
                        }
                    });

                    this.filteredFiles = filtered;
                },

                // Select a file
                selectFile(file) {
                    this.selectedFile = file;
                    console.log('Selected file:', file.file_name);
                },

                // Format duration (ms to seconds)
                formatDuration(ms) {
                    if (!ms) return 'N/A';
                    const seconds = (ms / 1000).toFixed(1);
                    return `${seconds}s`;
                },

                // Error handlers
                handlePdfError() {
                    console.error('Failed to load PDF');
                    alert('Failed to load PDF. The file may not exist or is inaccessible.');
                },

                handleMarkdownError() {
                    console.error('Failed to load Markdown');
                    alert('Failed to load Markdown. The file may not exist or is inaccessible.');
                }
            };
        }
    </script>
</body>
</html>
